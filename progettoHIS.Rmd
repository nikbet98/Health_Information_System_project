---
title: "Health Informatio System project "
author: "Bettinzoli Nicola"
date: "2024-06-18"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introdution

The purpose of this report is to analyse the current state and the evolution of the air quality in the region of Lombardy. During this study i will analize the various concentration of the pollutants in the air and try to identify pattern or trend of the territory.  
  

# Library used

```{r library, ECHO = FALSE}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(tidyr)
})
```

# Datasets used


## Dati sensori aria

The main dataset utilized is the one containing all the sensor readings, this dataset can be downloaded from <https://www.dati.lombardia.it/Ambiente/Dati-sensori-aria-dal-2018/g2hp-ar79/about_data>. Let's try to have a look

<!-- import of the dataset of the readings  -->
```{r}
df <- read.csv("./datasets/sensor_readings.csv")
head(df)
```

And the structure
```{r}
str(df)
```


In this dataset each row rappresent a sensor reading, each reading is described by: The id of the sensor, the date, the value, the state and the id of the operator.

## Dati stazioni qualitÃ  dell'aria


<!-- import the dataset of the station used and look at its structure -->
```{r}
df_stations <- read.csv("./datasets/station_dataset.csv")
str(df_stations)
```

# Cleaning and manipuleting the datasets

## Check for NA records

<!-- check how many records in the dataset are NA  -->
```{r}
table(df$Stato, useNA = "always")
```
<!-- double check on the "Valore" field -->
```{r}
length(which(df$Valore == -9999))
```

<!-- drop Na rows -->
```{r, ECHO = FALSE}
df <- drop_na(df)
```

## Date feature

<!-- split the "Data" column into date and time -->
```{r}
dates <- df$Data
```

```{r}
dates <- format(as.POSIXct(dates, format="%d/%m/%Y %H:%M:%S"))
```

```{r}
times <- as.integer(format(as.POSIXct(dates), format = "%H:%M:%S"), format = "%H")
```

```{r}
dates <- as.Date(dates)
```

<!-- insert the new features into the dataset -->
```{r}
df$Dates <- dates

df$Times <- times
```

<!-- remove the useless column column -->
```{r}
df <- subset(df, select = -c(Data,idOperatore,Stato))
```

<!-- change the name of the id column, this for compatibility reason with the other dataset -->
```{r}
df <- rename(df,"IdSensore" = "idSensore")
```

<!-- check if all the ids of the first dataset exist in the second -->
```{r}
ids <- df$IdSensore
for (id in ids){
  if (!(id %in% df_stations$IdSensore))
    print("sensor "+id+" not present in the dataset")
}
  
```

<!-- join the two dataset based on the "IdSensore" feature -->
```{r}
df <- left_join(df,df_stations, by = "IdSensore")
```

<!-- remove some column that are not relevant -->
```{r}
df <- subset(df, select = -c(NomeStazione,Storico))
```

<!-- check the value in the dataset -->
```{r}
df %>% group_by(NomeTipoSensore) %>% summarize(
  min = min(Valore),
  max = max(Valore),
  mean = mean(Valore),
  quant25 = quantile(Valore, probs = 0.25),
  quant50 = quantile(Valore, probs = 0.50),
  quant75 = quantile(Valore, probs = 0.75)
)
```

Some value are negative, probably there was some error with the sensor, and there are some strange value way higher than the quant75.

So it might be necessary to discharge some record.

<!-- remove all records with negative value -->
```{r, echo=FALSE}
df <- df %>% filter(Valore > 0)
```

<!-- detect outlier -->
```{r}
remove_outlier <- function(df){
  
  category <- unique(df$NomeTipoSensore) 
  
  for (c in category){
    values <- df$Valore[df$NomeTipoSensore == c]
    
    quantile25 <- quantile(values, probs = 0.25)
    
    
    quantile75 <- quantile(values, probs = 0.75)
    
    IQR <- quantile75 - quantile25
    
    df <- df %>% filter(!(NomeTipoSensore == c & (Valore > quantile75 + (IQR * 1.5) | Valore < quantile25 - (IQR * 1.5))))
  }
  return(df)
}
```

```{r}
df <- remove_outlier(df)
```

```{r}
df %>% group_by(NomeTipoSensore) %>% summarize(
  min = min(Valore),
  max = max(Valore),
  mean = mean(Valore),
  quant25 = quantile(Valore, probs = 0.25),
  quant50 = quantile(Valore, probs = 0.50),
  quant75 = quantile(Valore, probs = 0.75)
)
```

# Analyses


# Conclusions



