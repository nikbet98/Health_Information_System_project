---
title: "Health Informatio System project "
author: "Bettinzoli Nicola"
date: "2024-06-18"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Introdution

The purpose of this report is to analyse the current state and the evolution of the air quality in the region of Lombardy. During this study i will analize the various concentration of the pollutants in the air and try to identify pattern or trend of the territory.  
  

# Library used

```{r library, ECHO = FALSE}
suppressPackageStartupMessages({
  library(dplyr)
  library(ggplot2)
  library(ggmap)
  library(tidyr)
  library(patchwork)
  library(data.table)
  library(ggridges)
})
```

# Datasets used


## Dati sensori aria

The main dataset utilized is the one containing all the sensor readings, this dataset can be downloaded from <https://www.dati.lombardia.it/Ambiente/Dati-sensori-aria-dal-2018/g2hp-ar79/about_data>. Let's try to have a look

<!-- import of the dataset of the readings  -->
```{r}
df <- read.csv("./datasets/sensor_readings.csv")
head(df)
```

And the structure
```{r}
str(df)
```


In this dataset each row rappresent a sensor reading, each reading is described by: The id of the sensor, the date, the value, the state and the id of the operator.

## Dati stazioni qualitÃ  dell'aria


<!-- import the dataset of the station used and look at its structure -->
```{r}
df_stations <- read.csv("./datasets/station_dataset.csv")
str(df_stations)
```

# Cleaning and manipuleting the datasets

## Check for NA records

<!-- check how many records in the dataset are NA  -->
```{r}
table(df$Stato, useNA = "always")
```
<!-- double check on the "Valore" field -->
```{r}
length(which(df$Valore == -9999))
```

<!-- drop Na rows -->
```{r, ECHO = FALSE}
df <- drop_na(df)
```

## Date feature

<!-- split the "Data" column into date and time -->
```{r}
dates <- df$Data
```

```{r}
dates <- format(as.POSIXct(dates, format="%d/%m/%Y %H:%M:%S"))
```

```{r}
times <- as.integer(format(as.POSIXct(dates), format = "%H:%M:%S"), format = "%H")
```

```{r}
dates <- as.Date(dates)
```

<!-- insert the new features into the dataset -->
```{r}
df$Dates <- dates

df$Times <- times
```

<!-- keep only the hour -->
```{r}
df$Times <- as.integer(format(as.POSIXct(df$Times, format = "%H:%M:%S"), format = "%H"))
```


<!-- remove the useless column column -->
```{r}
df <- subset(df, select = -c(Data,idOperatore,Stato))
```

<!-- change the name of the id column, this for compatibility reason with the other dataset -->
```{r}
df <- rename(df,"IdSensore" = "idSensore")
```

<!-- check if all the ids of the first dataset exist in the second -->
```{r}
ids <- df$IdSensore
for (id in ids){
  if (!(id %in% df_stations$IdSensore))
    print("sensor "+id+" not present in the dataset")
}
  
```

<!-- join the two dataset based on the "IdSensore" feature -->
```{r}
df <- left_join(df,df_stations, by = "IdSensore")
```

<!-- remove some column that are not relevant -->
```{r}
df <- subset(df, select = -c(NomeStazione,Storico))
```

<!-- check the value in the dataset -->
```{r}
df %>% group_by(NomeTipoSensore) %>% summarize(
  min = min(Valore),
  max = max(Valore),
  mean = mean(Valore),
  quant25 = quantile(Valore, probs = 0.25),
  quant50 = quantile(Valore, probs = 0.50),
  quant75 = quantile(Valore, probs = 0.75)
)
```

Some value are negative, probably there was some error with the sensor, and there are some strange value way higher than the quant75.

So it might be necessary to discharge some record.

<!-- remove all records with negative value -->
```{r, echo=FALSE}
df <- df %>% filter(Valore > 0)
```

<!-- detect outlier -->
```{r}
p <- ggplot(df) +
  aes(x = "", y = Valore) +
  geom_boxplot(fill = "steelblue") + 
  theme_minimal()

p + facet_wrap(vars(NomeTipoSensore),scales = "free_y")

```
  
  <!-- remove outlier -->
```{r}
remove_outlier <- function(df){
  
  category <- unique(df$NomeTipoSensore) 
  
  for (c in category){
    values <- df$Valore[df$NomeTipoSensore == c]
    
    quantile25 <- quantile(values, probs = 0.25)
    
    
    quantile75 <- quantile(values, probs = 0.75)
    
    IQR <- quantile75 - quantile25
    
    df <- df %>% filter(!(NomeTipoSensore == c & (Valore > quantile75 + (IQR * 1.5) | Valore < quantile25 - (IQR * 1.5))))
  }
  return(df)
}
```

```{r}
df <- remove_outlier(df)
```

<!-- boxplots again but after the outlier got removed -->
```{r}
p <- ggplot(df) +
  aes(x = "", y = Valore) +
  geom_boxplot(fill = "steelblue") + 
  theme_minimal()

p + facet_wrap(vars(NomeTipoSensore),scales = "free_y")
```


```{r}
df %>% group_by(NomeTipoSensore) %>% summarize(
  min = min(Valore),
  max = max(Valore),
  mean = mean(Valore),
  quant25 = quantile(Valore, probs = 0.25),
  quant50 = quantile(Valore, probs = 0.50),
  quant75 = quantile(Valore, probs = 0.75)
)
```


# Analyses


<!-- to check:  Biossido di Azoto, Monossido di Azoto, Ossidi di Azoto, Biossido di Zolfo, Monossido di Carbonio, Ozono, PM10 (SM2005), Particelle sospese PM2.5 -->

<!-- pollutans of interest -->
```{r}
pollutans <- c("Biossido di Azoto", "Monossido di Azoto", "Ossidi di Azoto", "Biossido di Zolfo", "Monossido di Carbonio", "Ozono", "PM10 (SM2005)", "Particelle sospese PM2.5")
```

```{r}
df <- df %>% filter(NomeTipoSensore %in% pollutans)
```



<!-- small dataframe with only the stations and their location -->
```{r}
station <- df %>% subset(select = c(Idstazione,lat,lng,Utm_Nord,UTM_Est,Quota)) %>% group_by(Idstazione) %>% summarise(lat = mean(lat), lng = mean(lng), Utm_Nord = mean(Utm_Nord),UTM_Est = mean(UTM_Est), Quota = mean(Quota))
```

<!-- api key for using stadia maps -->

```{r}
api_key <- readLines("stadia_key.txt")
register_stadiamaps(api_key, write = FALSE)
```


<!-- plot the station on a map -->
```{r}
qmplot(x=lng,y=lat,data = station, source = "stadia",maptype = "stamen_toner_lite", color = I("red"))
```

```{r}
p <- ggmap(map) + 
  geom_density_2d_filled(data = station, 
                         aes(x=lng, y=lat, alpha = 0.3))
p
ggsave("./image/stations_desnity.png", plot=p, width=13, height=7, dpi=300)
```

<!-- piechart of the various pollutants readings and sensors -->
```{r}
sensor_count <- df_stations %>% 
  group_by(NomeTipoSensore) %>%  
  filter(NomeTipoSensore %in% pollutans & IdSensore %in% df$IdSensore) %>% 
  summarise(n = n())

total <- sum(sensor_count$n)
  
sensor_count$perc <- sensor_count$n / total
sensor_count$perc <- sprintf("%1.2f%%", 100*sensor_count$perc)
  

ggplot(sensor_count, aes(x="", y=n, fill=NomeTipoSensore)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  geom_text(aes(label = perc), position = position_stack(vjust=0.5)) +
  theme_void()
```



```{r}
raeadings_count <- df %>% 
  group_by(NomeTipoSensore) %>% 
  summarise(n = n())

total <- sum(raeadings_count$n)
  
raeadings_count$perc <- raeadings_count$n / total
raeadings_count$perc <- sprintf("%1.2f%%", 100*raeadings_count$perc)
  

p <- ggplot(raeadings_count, aes(x="", y=n, fill=NomeTipoSensore)) + 
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  geom_text(aes(label = perc), position = position_stack(vjust=0.5)) +
  theme_void()

p

ggsave("readings_count_pie.png", plot=p, width=7.5, height=5, dpi=150)
```
```{r}
df$Dates <- df$Dates %>% as.Date()
```


```{r}
df$Year <- df$Dates %>% format("%Y")

df$Month <- df$Dates %>% format("%m")

df$DayOfTheWeek <- df$Dates %>% weekdays()
```

<!-- annual averages -->
```{r}
annual_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,Year)) %>% 
  filter(Year < 2024) %>%
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)
```

```{r}
years <- 2018:2023
annual_averages <- setDT(annual_averages)
mtab = melt(annual_averages, id.vars="Year")

mtab$Year = factor(mtab$Year, levels=c(years))

p <- ggplot(data=mtab, aes(x=Year, y=value, fill=Year)) + 
  geom_bar(stat="identity") +
  scale_fill_viridis_d() +
  facet_wrap(vars(variable),scales = "free_y")

ggsave("faceted_barplot.png", plot=p, width=7.5, height=5, dpi=150)
```

<!-- month averages -->
```{r}
month_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,Month)) %>% 
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)

month_averages$Month <- as.integer(month_averages$Month)
```

```{r}
months <- 1:12
month_averages <- setDT(month_averages)
mtab = melt(month_averages, id.vars="Month")

mtab$Month = factor(mtab$Month, levels=c(months))

p <- ggplot(data=mtab, aes(x=Month, y=value, fill=Month)) + 
  geom_bar(stat="identity") +
  scale_fill_viridis_d() +
  facet_wrap(vars(variable),scales = "free_y")

ggsave("months.png", plot=p, width=7.5, height=5, dpi=150)
```


<!-- day averages -->
```{r}
day_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,DayOfTheWeek)) %>% 
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)

```

```{r}
days <- day_averages$DayOfTheWeek
day_averages <- setDT(day_averages)
mtab = melt(day_averages, id.vars="DayOfTheWeek")

mtab$DayOfTheWeek = factor(mtab$DayOfTheWeek, levels=c(days))

p <- ggplot(data=mtab, aes(x=DayOfTheWeek, y=value, fill=DayOfTheWeek)) + 
  geom_bar(stat="identity")
  scale_fill_viridis_d() +
  facet_wrap(vars(variable),scales = "free_y")

ggsave("days.png", plot=p, width=7.5, height=5, dpi=150)
```

<!-- hour averages -->
```{r}
hours <- 0:23
hour_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,Times)) %>% 
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)

```

```{r}
hour_averages <- setDT(hour_averages)
mtab = melt(hour_averages, id.vars="Times")

mtab$Times = factor(mtab$Times, levels=c(hours))

p <- ggplot(data=mtab, aes(x=Times, y=value, fill=Times)) + 
  geom_bar(stat="identity") +
  scale_fill_viridis_d() +
  facet_wrap(vars(variable),scales = "free_y")

p
ggsave("hours.png", plot=p, width=13, height=7, dpi=150)
```

<!-- averages for each province -->
```{r}
provinces <- unique(df$Provincia)
provinces_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,Provincia)) %>% 
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)

```

```{r}
provinces_averages <- setDT(provinces_averages)
mtab = melt(provinces_averages, id.vars="Provincia")

mtab$Provincia = factor(mtab$Provincia, levels=c(provinces))

p <- ggplot(data=mtab, aes(x=Provincia, y=value, fill=Provincia)) + 
  geom_bar(stat="identity") +
  scale_fill_viridis_d() +
  facet_wrap(vars(variable),scales = "free_y")

p
ggsave("./image/provinces.png", plot=p, width=13, height=7, dpi=150)
```
<!-- temporal evolution -->
```{r}
value_means <- function(df, pollutan){
  temp <- filter(df,df$NomeTipoSensore == pollutan)
  temp <- temp %>% subset(select = c(Dates,Valore)) %>% group_by(Dates) %>% summarise(value = mean(Valore))
  return(temp)
}
```

```{r}
for (c in pollutans){
  temp <- value_means(df,c)
  p <- ggplot(temp) + 
    aes(x=Dates, y=value, title(c)) +
    geom_line(color = "red") +
    geom_smooth()
  path <- paste("./image/",gsub(" ","",c),".png",sep="")
  ggsave(path, plot=p, width=20, height=10, dpi=150)
}
```

<!-- check the most polluted city -->
```{r}
cities <- unique(df$Comune)
cities_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,Comune)) %>% 
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)

```

<!-- top 10 foreach pollutans -->
```{r}
for (c in pollutans){
  temp <- df %>% 
    subset(select = c(NomeTipoSensore,Valore,Comune)) %>% 
    filter(NomeTipoSensore == c) %>%
    group_by(Comune) %>%
    summarise(average = mean(Valore)) %>%
    arrange(desc(average)) %>%
    head(10)
  
  p <- ggplot(temp) +
    aes(x=factor(Comune, level=c(Comune)), y=average, fill = Comune) +
    geom_bar(stat="identity") +
    scale_fill_viridis_d() +
    ggtitle(c) +
    theme(plot.title = element_text(hjust = 0.5))
  path <- paste("./image/top_10_",gsub(" ","",c),".png",sep="")
  ggsave(path, plot=p, width=20, height=10, dpi=150)
}
```

<!-- heatmap -->
```{r}
prova <- df %>% 
  filter(NomeTipoSensore == "Particelle sospese PM2.5") %>% 
  subset(select = c(lat,lng,Valore) )
```

```{r}
bb <- getbb("Lombardia")
map <- get_stadiamap(bbox = c(bb[1,1],bb[2,1],bb[1,2],bb[2,2]), maptype = "alidade_smooth")
```

```{r}
p <- ggmap(map) + 
  geom_density_2d_filled(data = prova, 
                         aes(x=lng, y=lat, alpha = 0.3))

ggsave("prova.png", plot=p, width=13, height=7, dpi=300)
```


```{r}
ggmap(map)
```
```{r}
month_averages <- df %>% 
  subset(select = c(NomeTipoSensore,Valore,Month)) %>% 
  pivot_wider(names_from = NomeTipoSensore, values_from = Valore, values_fn = mean)

month_averages$Month <- as.integer(month_averages$Month)

months <- 1:12
month_averages <- setDT(month_averages)
mtab = melt(month_averages, id.vars="Month")

mtab$Month = factor(mtab$Month, levels=c(months))
```


```{r}
ggplot(mtab, aes(x = value, y = variable, fill = variable)) +
  geom_density_ridges() +
  scale_x_continuous(expand = c(0.01, 0)) +
  scale_y_discrete(expand = c(0.01, 0)) +
  scale_fill_viridis_d()
 
```
```{r}
prova<- prova %>% mutate(across(c(lat, lng), round, digits = 4))
```


```{r}

p <- ggmap(map) + 
  geom_point(data = prova,mapping = aes(x = lng, y = lat, size = mean, color = mean, alpha = 0.4)) +
  scale_color_gradientn(colors = rainbow(5)) +
  scale_fill_viridis_d() +
  guides(size = FALSE, alpha = FALSE)
p
ggsave("pm25.png", plot=p, width=13, height=7, dpi=300)

```

https://dati.comune.milano.it/dataset/ds686-rilevazione-temperature-anno-2018

<!-- load the dataset of Milan's temps and clean it -->
```{r}
milan_temps <- read.csv("./datasets/milano_temps.csv", sep = ";", na.strings = " ")
milan_temps <- drop_na(milano_temps)
milan_temps$Media <- gsub(",", ".", milano_temps$Media)
milan_temps$Media <- as.numeric(milano_temps$Media)
milan_temps$Data.Ora <- as.Date(milano_temps$Data.Ora, format = "%d/%m/%Y %H:%M")
milan_temps <- milano_temps %>% group_by(Data.Ora) %>% summarise(Media = mean(Media))
```


```{r}
milan_2018 <- df %>% filter(Dates < "2019/01/01" & Provincia == "MI")
```

<!-- pollutants and the temperature plots side by side -->
```{r}
for (c in pollutans){
  temp <- value_means(milan_2018,c)
  p <- ggplot(temp) + 
    aes(x=Dates, y=value, title(c)) +
    geom_line(color = "red") +
    geom_smooth() +
    ggplot(data = milano_temps,
              aes(x=Data.Ora, y = Media, color = "green")) +
    geom_smooth()
  path <- paste("./image/",gsub(" ","",c),".png",sep="")
  ggsave(path, plot=p, width=20, height=10, dpi=150)
}
```

<!-- annual and daily mean vs WHO guidelines -->
```{r}
ggplot(annual_averages) +
  aes(x=Year, y=`Particelle sospese PM2.5`, group = 1) +
  geom_line() +
  geom_hline(yintercept=25, linetype="dashed", color = "red") +
  geom_hline(yintercept=15, linetype="dashed", color = "red") +
  geom_hline(yintercept=10, linetype="dashed", color = "red")

```

```{r}
averages <- df %>% 
  filter(NomeTipoSensore == "Particelle sospese PM2.5") %>%
  group_by(Dates) %>% 
  summarise(mean = mean(Valore))

ggplot(averages) +
  aes(x=Dates, y=mean, group = 1) +
  geom_line() +
  geom_hline(yintercept=75, linetype="dashed", color = "red") +
  geom_hline(yintercept=50, linetype="dashed", color = "red") +
  geom_hline(yintercept=37.5, linetype="dashed", color = "red") +
  geom_hline(yintercept=25, linetype="dashed", color = "red")


```


# Conclusions



